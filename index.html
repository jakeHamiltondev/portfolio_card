<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Portfolio Card</title>

  <link rel="stylesheet" href="css/styles.css" />

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/portfolio.js"></script>
</head>

<body>
  <!-- =================================
       FLOATING NAVIGATION BUTTONS
       Always visible fixed buttons for navigation
       ================================= -->
  <button class="home-btn" onclick="openHome()" aria-label="Open home panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </button>

  <button class="share-btn" onclick="openShare()" id="shareButton" aria-label="Open share panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
      <polyline points="16 6 12 2 8 6"></polyline>
      <line x1="12" y1="2" x2="12" y2="15"></line>
    </svg>
  </button>

  <button class="settings-btn" onclick="openSettings()" aria-label="Open settings">
    <span class="settings-btn-inner">
      <svg class="gear" width="24" height="24" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </span>
  </button>

  <!-- =================================
       SAVE CONTACT BUTTON
       Only visible when viewing someone else's shared card
       ================================= -->
  <button class="save-contact-btn" id="saveContactBtn" onclick="saveContact()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
    </svg>
    Save to My Contacts
  </button>

  <!-- =================================
       BUSINESS CARD
       3D flip card with front and back faces
       ================================= -->
  <div class="card-container" onclick="flipCard()">
    <div class="card" id="businessCard">

      <!-- FRONT FACE: Large profile picture -->
      <div class="card-face card-front" id="cardFront">
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic"
          id="profilePic"
        />
      </div>

      <!-- BACK FACE: Contact information and portfolio links -->
      <div class="card-face card-back" id="cardBack">
        <!-- Small profile picture in corner -->
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic-small"
          id="profilePicSmall"
        />

        <div class="left-content">
          <!-- Contact information section -->
          <div>
            <div class="contact-info">
              <!-- Name links to LinkedIn profile -->
              <a id="nameLink" target="_blank" style="color: white; text-decoration: none;">
                <h2 id="fullName">John Doe</h2>
                <div id="jobTitle" style="font-size:14px;opacity:.9;margin:4px 0 10px;"></div>
              </a>
            </div>

            <!-- Email -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <a href="mailto:john.doe@email.com" id="emailLink" style="color: white; text-decoration: none;">
                <span id="emailText">john.doe@email.com</span>
              </a>
            </div>

            <!-- Phone -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <a href="tel:+15551234567" id="phoneLink" style="color: white; text-decoration: none;">
                <span id="phoneText">+1 (555) 123-4567</span>
              </a>
            </div>

            <!-- LinkedIn -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect x="2" y="9" width="4" height="12"></rect>
                <circle cx="4" cy="4" r="2"></circle>
              </svg>
              <a href="https://linkedin.com/in/johndoe" id="linkedinLink" target="_blank" style="color: white; text-decoration: none;">linkedin.com/in/johndoe</a>
            </div>
          </div>

          <!-- Portfolio links section -->
          <div>
            <div class="portfolio-links" id="portfolioSection">
              <h3>PORTFOLIO</h3>
              <div class="portfolio-links-grid">
                <button class="portfolio-link" data-link-type="cert">Certifications</button>
                <button class="portfolio-link" data-link-type="edu">Education</button>
                <button class="portfolio-link" data-link-type="proj">Projects</button>
                <button class="portfolio-link" data-link-type="ref">References</button>
                <button class="portfolio-link" data-link-type="resume">Resume</button>
                <button class="portfolio-link" data-link-type="work">Work</button>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /card-back -->

    </div>
  </div>

  <!-- Hint text for first-time users -->
  <div class="hint-text" id="hintText">Click card to see contact info</div>

  <!-- =================================
       HOME PANEL
       Shows user's own card and saved contacts
       ================================= -->
  <div class="home-panel" id="homePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeHome()">←</button>
        <h2>My Collection</h2>
      </div>
    </div>

    <!-- Tab navigation -->
    <div class="tab-container">
      <div class="tab-ribbon" id="tabRibbon">
        <button class="tab active" onclick="switchTab('myCard')">My Card</button>
        <button class="tab" onclick="switchTab('contacts')">Saved Contacts</button>
      </div>
    </div>

    <div class="home-content">
      <!-- My Card tab content -->
      <div class="tab-content active" id="myCardTab">
        <div id="myCardSection"></div>
      </div>

      <!-- Saved Contacts tab content -->
      <div class="tab-content" id="contactsTab">
        <div class="cards-grid" id="contactsGrid"></div>
      </div>
    </div>
  </div>

  <!-- =================================
       SHARE PANEL
       QR code generation and link sharing
       ================================= -->
  <div class="share-panel" id="sharePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeShare()">←</button>
        <h2>Share My Card</h2>
      </div>
    </div>

    <div class="share-content">
      <h3 style="margin-bottom: 10px;">Share via QR Code</h3>

      <p class="share-instructions">
        Others can scan this QR code to view and save your business card.
      </p>

      <div class="qr-code-container">
        <div id="qrcode"></div>

        <!-- Action buttons for QR code -->
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
          <button class="action-btn" onclick="generateQRCode()">Regenerate</button>
          <button class="action-btn" onclick="copyShareLink()">Copy Link</button>
          <button class="action-btn" onclick="openShareLink()">Open Link</button>
        </div>
      </div>

      <!-- Warning messages for network issues -->
      <div id="qrWarnings" style="max-width:500px;margin:0 auto;text-align:center;color:#b91c1c;"></div>
    </div>
  </div>

  <!-- =================================
       SETTINGS PANEL
       Edit card information and preferences
       ================================= -->
  <div class="settings-panel" id="settingsPanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeSettings()">←</button>
        <h2>My Card Settings</h2>
      </div>
    </div>

    <div class="settings-content">
      <div class="section-title">PROFILE INFORMATION</div>

      <!-- Profile picture upload -->
      <div class="form-group">
        <label>Profile Picture</label>
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px; max-width: 100%">
          <!-- Preview of current/selected image -->
          <img
            id="previewPic"
            src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
            alt="Preview"
            style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #d1d5db; flex-shrink: 0"
          />
          <div style="flex: 1; min-width: 0; max-width: 100%;">
            <input
              type="file"
              id="profilePicInput"
              accept="image/*"
              style="padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; font-size: 14px; max-width: 100%; box-sizing: border-box;"
            />
            <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Upload a photo from your device</p>
          </div>
        </div>
      </div>

      <!-- Basic information fields -->
      <div class="form-group">
        <label>First Name (Required)</label>
        <input type="text" id="firstNameInput" value="John" placeholder="ex: John" />
      </div>

      <div class="form-group">
        <label>Last Name (Required)</label>
        <input type="text" id="lastNameInput" value="Doe" placeholder="ex: Doe" />
      </div>

      <div class="form-group">
        <label>Job Title</label>
        <input type="text" id="jobTitleInput" value="Student" placeholder="Student"/>
      </div>

      <div class="form-group">
        <label>Email (Required)</label>
        <input type="email" id="emailInput" value="john.doe@email.com" placeholder="ex: john.doe@email.com"/>
        <div class="email-error-box" id="emailErrorBox"></div>
      </div>

      <!-- Phone number with country code -->
      <div class="form-group">
        <label>Phone (Required)</label>
        <div class="phone-inputs">
          <select id="countryCodeSelect" aria-label="Country code">
            <option value="">Country code…</option>
            <option value="1">+1</option>
            <option value="44">+44</option>
            <option value="61">+61</option>
            <option value="81">+81</option>
            <option value="91">+91</option>
            <option value="353">+353</option>
          </select>
          <input
            id="localNumberInput"
            type="text"
            inputmode="numeric"
            pattern="\d*"
            maxlength="10"
            placeholder="10 digits"
          />
        </div>
        <div id="phoneError" class="email-error-box" style="display: none;"></div>
      </div>

      <div class="form-group">
        <label>LinkedIn URL</label>
        <input type="text" id="linkedinInput" value="https://linkedin.com/in/johndoe" placeholder="https://linkedin.com/in/yourname" />
      </div>

      <!-- Portfolio links section -->
      <div class="section-title">PORTFOLIO LINKS</div>

      <!-- Visibility toggles for portfolio items -->
      <div class="form-group">
        <label>Portfolio Items to Display</label>
        <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
          Select which portfolio items you want to show on your card
        </p>
        <div id="portfolioVisibilityOptions" style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showCertifications" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Certifications</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showEducation" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Education</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showProjects" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Projects</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showReferences" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>References</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showResume" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Resume</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showWork" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Work</span>
          </label>
        </div>
      </div>

      <!-- URL inputs for each portfolio item -->
      <div class="form-group">
        <label>Certifications Page URL</label>
        <input type="text" id="certPageInput" value="" placeholder="https://example.com/certifications" />
      </div>

      <div class="form-group">
        <label>Education Page URL</label>
        <input type="text" id="eduPageInput" value="" placeholder="https://example.com/education" />
      </div>

      <div class="form-group">
        <label>Projects Page URL</label>
        <input type="text" id="projPageInput" value="" placeholder="https://example.com/projects" />
      </div>

      <div class="form-group">
        <label>References Page URL</label>
        <input type="text" id="refPageInput" value="" placeholder="https://example.com/references" />
      </div>

      <div class="form-group">
        <label>Resume URL - PDF Format</label>
        <input type="text" id="resumePdfInput" value="" placeholder="https://example.com/resume.pdf" />
        <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Link to your resume in PDF format</p>
      </div>

      <div class="form-group">
        <label>Resume URL - DOCX Format</label>
        <input type="text" id="resumeDocxInput" value="" placeholder="https://example.com/resume.docx" />
        <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Link to your resume in Word format (optional)</p>
      </div>

      <div class="form-group">
        <label>Work Experience URL</label>
        <input type="text" id="workPageInput" value="" placeholder="https://example.com/work" />
      </div>

      <!-- Customization section -->
      <div class="section-title">CUSTOMIZATION</div>

      <div class="form-group">
        <label>Card Color</label>
        <div class="color-input-group">
          <input type="color" id="cardColorPicker" value="#6366f1" />
          <input type="text" id="cardColorInput" value="#6366f1" />
        </div>
      </div>

      <div class="form-group">
        <label>Background Color</label>
        <div class="color-input-group">
          <input type="color" id="bgColorPicker" value="#6B46C1" />
          <input type="text" id="bgColorInput" value="#6B46C1" />
        </div>
      </div>

      <!-- Action buttons -->
      <button class="save-btn" onclick="saveSettings()">Save My Card</button>
      <button class="save-btn" onclick="resetToJohnDoe()" style="margin-top:12px;background:#ef4444">
        Reset Card to Default (John Doe)
      </button>
    </div>
  </div>

  <script>
    /* ==========================================================
       GLOBAL STATE VARIABLES
       Core application state management
       ========================================================== */

    // Card flip state
    let isFlipped = false;

    // Shared card viewing state
    let viewingSharedCard = false;  // true when viewing someone else's card via URL
    let sharedCardData = null;      // decoded data from ?card= URL parameter

    // Temporary storage for image uploads before saving
    let uploadedImageData = null;

    /* ==========================================================
       INITIALIZATION
       Check URL for shared card on page load
       ========================================================== */

    window.addEventListener('DOMContentLoaded', () => {
      checkForSharedCard();
    });

    /* ==========================================================
       SHARED CARD DETECTION
       Check URL parameters for shared card data
       ========================================================== */

    /**
     * Check if URL contains ?card= parameter and load shared card
     * Called on page load to determine viewing mode
     */
    function checkForSharedCard() {
      const urlParams = new URLSearchParams(window.location.search);
      const cardData = urlParams.get('card');

      if (cardData) {
        // We're viewing a shared card
        viewingSharedCard = true;

        try {
          // Decode the card data from URL
          sharedCardData = decodeObj(cardData);
          applyCardData(sharedCardData);

          // Show save button for visitors
          const saveBtn = document.getElementById('saveContactBtn');
          if (saveBtn) saveBtn.classList.add('show');

          // Hide share button (doesn't make sense for visitors)
          const shareBtn = document.getElementById('shareButton');
          if (shareBtn) shareBtn.style.display = 'none';

          // Update hint text
          const hint = document.getElementById('hintText');
          if (hint) hint.textContent = 'Click card to see full details';
        } catch (error) {
          console.error('Invalid card data:', error);
          loadMyCard(); // Fall back to user's own card
        }
      } else {
        // No shared card, load user's own card
        loadMyCard();
      }
    }

    /* ==========================================================
       PERSONAL CARD LOADING
       Load user's saved card from localStorage
       ========================================================== */

    /**
     * Load the user's own business card from localStorage
     * Falls back to default card if none exists
     */
    function loadMyCard() {
      viewingSharedCard = false;

      const cardData = getMyCard();

      if (cardData) {
        applyCardData(cardData);
      } else {
        // No saved card, use default template
        applyCardData(DEFAULT_CARD);
      }
    }

    /* ==========================================================
       SHARE PAYLOAD BUILDER
       Create sanitized object for sharing (excludes sensitive data)
       ========================================================== */

    /**
     * Build a share-safe version of card data
     * Excludes large file blobs and sensitive information
     * @param {Object} cardData - Full card data
     * @returns {Object} Sanitized card data for sharing
     */
    function buildShareObj(cardData) {
      // Ensure resume is properly structured
      let resumeData = cardData.portfolioLinks?.resume;
      if (typeof resumeData === 'string') {
        // Backward compatibility: convert old string format to new object format
        resumeData = { pdf: resumeData, docx: '' };
      } else if (!resumeData) {
        resumeData = { pdf: '', docx: '' };
      }

      return {
        firstName: cardData.firstName,
        lastName: cardData.lastName,
        jobTitle: cardData.jobTitle,
        email: cardData.email,
        phone: cardData.phone,
        phoneE164: cardData.phoneE164,
        linkedin: cardData.linkedin,
        cardColor: cardData.cardColor,
        bgColor: cardData.bgColor,
        profilePic: cardData.profilePic,
        portfolioLinks: {
          ...cardData.portfolioLinks,
          resume: resumeData
        },
        portfolioVisibility: cardData.portfolioVisibility || { 
          cert: true, edu: true, proj: true, ref: true, resume: true, work: true 
        }
      };
    }

    /* ==========================================================
       CARD FLIP INTERACTION
       Toggle between front (photo) and back (info)
       ========================================================== */

    /**
     * Flip the business card to show opposite side
     * Triggered by clicking the card
     */
    function flipCard() {
      const card = document.getElementById('businessCard');
      const hint = document.getElementById('hintText');

      isFlipped = !isFlipped;

      if (isFlipped) {
        card.classList.add('flipped');
        hint.style.display = 'none';
      } else {
        card.classList.remove('flipped');
        hint.style.display = 'block';
      }
    }

    /* ==========================================================
       PANEL NAVIGATION
       Open/close full-screen panels
       ========================================================== */

    /**
     * Open the home panel (My Card & Saved Contacts)
     */
    function openHome() {
      document.getElementById('homePanel').classList.add('active');
      loadMyCardSection();
      loadContacts();
    }

    /**
     * Close the home panel
     */
    function closeHome() {
      document.getElementById('homePanel').classList.remove('active');
    }

    /**
     * Open the share panel (QR code generation)
     */
    function openShare() {
      const myCard = getMyCard();
      if (!myCard) {
        alert('Please create your card in Settings first!');
        return;
      }

      document.getElementById('sharePanel').classList.add('active');
      generateQRCode();
    }

    /**
     * Close the share panel
     */
    function closeShare() {
      document.getElementById('sharePanel').classList.remove('active');
    }

    /**
     * Open the settings panel
     */
    function openSettings() {
      document.getElementById('settingsPanel').classList.add('active');
    }

    /**
     * Close the settings panel
     */
    function closeSettings() {
      document.getElementById('settingsPanel').classList.remove('active');
    }

    /* ==========================================================
       HOME PANEL TAB SWITCHING
       Toggle between My Card and Saved Contacts tabs
       ========================================================== */

    /**
     * Switch active tab in home panel
     * @param {string} tabName - Name of tab to activate ('myCard' or 'contacts')
     */
    function switchTab(tabName) {
      // Update tab button states
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content visibility
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Load appropriate content
      if (tabName === 'myCard') {
        loadMyCardSection();
      } else if (tabName === 'contacts') {
        loadContacts();
      }
    }

    /* ==========================================================
       MY CARD SECTION
       Display user's own card in home panel
       ========================================================== */

    /**
     * Load and display user's card in home panel
     * Shows empty state if no card exists
     */
    function loadMyCardSection() {
      const myCard = getMyCard();
      const section = document.getElementById('myCardSection');

      if (!myCard) {
        // Show empty state with create button
        section.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <h3>Create Your Business Card</h3>
            <p>Set up your digital business card to share with others</p>
            <button class="save-btn" onclick="openSettings()" style="max-width:200px;margin:20px auto 0;">Create My Card</button>
          </div>`;
        return;
      }

      // Calculate colors for styling
      const accent = myCard.cardColor || '#6366f1';
      const text = textOn(accent);
      const chipBg = text === '#ffffff' 
        ? 'rgba(255,255,255,0.2)' 
        : 'rgba(0,0,0,0.08)';
      const chipBorder = text === '#ffffff' ? '#ffffff' : 'rgba(0,0,0,0.2)';
      const editText = _lum(accent) > 0.85 ? '#111827' : accent;
      const borderColor = _lum(accent) < 0.45 ? '#ffffff' : '#111827';

      // Build name line with optional job title
      const nameLine = (myCard.jobTitle && myCard.jobTitle.trim())
        ? `${myCard.firstName} ${myCard.lastName} - ${myCard.jobTitle}`
        : `${myCard.firstName} ${myCard.lastName}`;

      // Render card preview
      section.innerHTML = `
        <div class="my-card-section" style="background:${accent};color:${text};border:2px solid ${borderColor}">
          <h3 style="color:${text}">My Business Card</h3>

          <div class="my-card-preview">
            <img src="${myCard.profilePic}" alt="${myCard.firstName}" class="my-card-pic">

            <div class="my-card-details">
              <h4 style="color:${text}">${nameLine}</h4>
              <p style="color:${text}">${myCard.email}</p>
              <p style="color:${text}">${myCard.phone || ''}</p>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="action-btn" onclick="closeHome(); openSettings();" 
              style="background:#fff;color:${editText};font-weight:600;border:1px solid ${chipBorder}">
              Edit Card
            </button>

            <button class="action-btn" onclick="closeHome(); openShare();" 
              style="background:${chipBg};color:${text};border:1px solid ${chipBorder};font-weight:600">
              Share Card
            </button>
          </div>
        </div>`;
    }

    /* ==========================================================
       SAVED CONTACTS MANAGEMENT
       Display, save, view, and delete saved contacts
       ========================================================== */

    /**
     * Load and display all saved contacts
     * Shows empty state if no contacts saved
     */
    function loadContacts() {
      const contacts = getSavedContacts();
      const grid = document.getElementById('contactsGrid');

      if (contacts.length === 0) {
        // Show empty state
        grid.classList.add('is-empty');
        grid.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h3>No contacts yet</h3>
            <p>When someone shares their card with you, save it here</p>
          </div>`;
        return;
      }

      grid.classList.remove('is-empty');

      // Render contact cards
      grid.innerHTML = contacts.map((contact, index) => `
        <div class="saved-card">
          <div class="saved-card-header">
            <img src="${contact.profilePic}" alt="${contact.firstName}" class="saved-card-pic">
            <div class="saved-card-info">
              <h3>${contact.firstName} ${contact.lastName}</h3>
              <p>${contact.email}</p>
            </div>
          </div>

          <div class="saved-card-actions">
            <button class="action-btn" onclick="viewContact(${index})">View</button>
            <button class="action-btn delete-btn" onclick="deleteContact(${index})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    /**
     * Save currently viewed shared card to contacts
     * Prevents duplicate saves
     */
    function saveContact() {
      if (!sharedCardData) return;

      const success = addContact(sharedCardData);

      if (!success) {
        alert('This contact is already in your collection!');
        return;
      }

      alert(`${sharedCardData.firstName} ${sharedCardData.lastName}'s card saved to your contacts!`);
      document.getElementById('saveContactBtn').classList.remove('show');
    }

    /**
     * View a saved contact's card
     * @param {number} index - Index of contact in saved contacts array
     */
    function viewContact(index) {
      const contacts = getSavedContacts();
      const contact = contacts[index];

      if (contact) {
        applyCardData(contact);
        closeHome();
      }
    }

    /**
     * Delete a saved contact
     * @param {number} index - Index of contact to delete
     */
    function deleteContact(index) {
      if (!confirm('Remove this contact?')) return;

      removeContact(index);
      loadContacts();
    }

    /* ==========================================================
       INPUT VALIDATION & FORMATTING
       Real-time validation for name, email, and phone inputs
       ========================================================== */

    /**
     * Initialize name input filters
     * Allows letters, hyphens, apostrophes, and spaces
     */
    setTimeout(() => {
      const firstNameInput = document.getElementById("firstNameInput");
      const lastNameInput = document.getElementById("lastNameInput");

      if (firstNameInput) {
        firstNameInput.addEventListener("input", () => {
          // Allow only valid name characters
          firstNameInput.value = firstNameInput.value.replace(/[^A-Za-z'-]/g, "");
        });
      }

      if (lastNameInput) {
        lastNameInput.addEventListener("input", () => {
          // Allow spaces in last names (for multi-part names)
          lastNameInput.value = lastNameInput.value.replace(/[^A-Za-z' -]/g, "");
        });
      }
    }, 300);

    /**
     * Email input filter - allows only valid email characters
     */
    document.getElementById("emailInput").addEventListener("input", function(event) {
      let value = event.target.value.toLowerCase();

      // Remove invalid characters
      value = value.replace(/[^a-z0-9@._-]/g, "");
      value = value.replace(/\s+/g, "");

      // Clean up domain part (no numbers in domain)
      if (value.includes("@")) {
        const atIndex = value.indexOf("@");
        let localPart = value.slice(0, atIndex);
        let domainPart = value.slice(atIndex + 1).replace(/[0-9]/g, "");
        value = localPart + "@" + domainPart;
      }

      event.target.value = value;
    });

    /**
     * Live email validation feedback
     */
    const emailInput = document.getElementById("emailInput");
    const emailErrorBox = document.getElementById("emailErrorBox");

    emailInput.addEventListener("input", () => {
      const value = emailInput.value.trim().toLowerCase();
      const errors = getEmailErrors(value);

      if (errors.length === 0) {
        emailErrorBox.style.display = "none";
        emailErrorBox.innerHTML = "";
      } else {
        emailErrorBox.style.display = "block";
        emailErrorBox.innerHTML = "⚠ Email is invalid:<br>• " + errors.join("<br>• ");
      }
    });

    /* ==========================================================
       PHONE NUMBER HANDLING
       Format and validate phone numbers with country codes
       ========================================================== */

    /**
     * Initialize phone number input filter (digits only, max 10)
     */
    (function initPhoneFilter() {
      const localInput = document.getElementById('localNumberInput');
      if (!localInput) return;

      const filter = () => {
        // Remove non-digits and limit to 10
        let value = localInput.value.replace(/\D+/g, '');
        if (value.length > 10) value = value.slice(0, 10);
        localInput.value = value;
      };

      ['input', 'paste', 'change', 'blur'].forEach(evt => {
        localInput.addEventListener(evt, filter);
      });
    })();

    /* ==========================================================
       SAVE SETTINGS
       Validate and save all card settings to localStorage
       ========================================================== */

    /**
     * Validate and save all card settings
     * Performs comprehensive validation before saving
     */
    function saveSettings() {
      // Validate and format names
      const firstName = formatName(document.getElementById('firstNameInput').value, false);
      const lastName = formatName(document.getElementById('lastNameInput').value, true);
      
      if (!firstName) {
        alert("Invalid first name.");
        return;
      }
      if (!lastName) {
        alert("Invalid last name.");
        return;
      }

      // Validate email
      const emailErrors = getEmailErrors(document.getElementById('emailInput').value);
      if (emailErrors.length) {
        alert("Email invalid:\n- " + emailErrors.join("\n- "));
        return;
      }

      // Get form values
      const email = document.getElementById('emailInput').value.trim().toLowerCase();
      const linkedin = fixUrl(document.getElementById('linkedinInput').value);
      const jobTitle = document.getElementById('jobTitleInput').value;

      // Validate phone number
      const countryCode = (document.getElementById('countryCodeSelect').value || '').trim();
      const localNumber = (document.getElementById('localNumberInput').value || '').trim();
      
      if (!countryCode) {
        showPhoneError('Please choose a country code.');
        return;
      }
      if (!ALLOWED_COUNTRY_CODES.includes(countryCode)) {
        showPhoneError('Country code is not allowed.');
        return;
      }
      if (localNumber.length !== 10) {
        showPhoneError('Phone number must be exactly 10 digits.');
        return;
      }
      if (!/^\d{10}$/.test(localNumber)) {
        showPhoneError('Phone number can contain digits only.');
        return;
      }
      showPhoneError('');

      // Get color values
      const cardColor = pickColor(
        document.getElementById('cardColorInput').value,
        document.getElementById('cardColorPicker').value,
        '#6366f1'
      );
      const bgColor = pickColor(
        document.getElementById('bgColorInput').value,
        document.getElementById('bgColorPicker').value,
        '#6B46C1'
      );

      // Get portfolio URLs and fix formatting
      const certPage = fixUrl(document.getElementById('certPageInput').value);
      const eduPage = fixUrl(document.getElementById('eduPageInput').value);
      const projPage = fixUrl(document.getElementById('projPageInput').value);
      const refPage = fixUrl(document.getElementById('refPageInput').value);
      const resumePdfPage = fixUrl(document.getElementById('resumePdfInput').value);
      const resumeDocxPage = fixUrl(document.getElementById('resumeDocxInput').value);
      const workPage = fixUrl(document.getElementById('workPageInput').value);

      // Get portfolio visibility settings
      const showCert = document.getElementById('showCertifications').checked;
      const showEdu = document.getElementById('showEducation').checked;
      const showProj = document.getElementById('showProjects').checked;
      const showRef = document.getElementById('showReferences').checked;
      const showResume = document.getElementById('showResume').checked;
      const showWork = document.getElementById('showWork').checked;

      // Get profile picture (uploaded or existing)
      let profilePicData = uploadedImageData || document.getElementById('profilePic').src;
      
      // Format phone number
      const formattedPhone = formatPhone(countryCode, localNumber);

      // Build card data object
      const cardData = {
        firstName: firstName,
        lastName: lastName,
        jobTitle: jobTitle,
        email: email,
        phone: formattedPhone.pretty,
        phoneE164: formattedPhone.e164,
        countryCode: countryCode,
        localNumber: localNumber,
        linkedin: linkedin,
        cardColor: cardColor,
        bgColor: bgColor,
        profilePic: profilePicData,
        portfolioLinks: {
          cert: certPage,
          edu: eduPage,
          proj: projPage,
          ref: refPage,
          resume: {
            pdf: resumePdfPage,
            docx: resumeDocxPage
          },
          work: workPage
        },
        portfolioVisibility: {
          cert: showCert,
          edu: showEdu,
          proj: showProj,
          ref: showRef,
          resume: showResume,
          work: showWork
        },
        lastUpdated: new Date().toISOString()
      };

      if (!saveMyCard(cardData)) {
        return;
      }

      // Apply to current card view
      applyCardData(cardData);
      loadMyCardSection();

      // Clear temporary upload data
      uploadedImageData = null;

      alert('Your card has been saved!');
      closeSettings();
    }

    /* ==========================================================
       QR CODE GENERATION
       Generate shareable QR code using quickchart.io
       ========================================================== */

    /**
     * Generate QR code for card sharing
     * Creates shareable URL and renders QR code image
     */
    function generateQRCode() {
      const rawCard = getMyCard();
      const qrContainer = document.getElementById('qrcode');
      const warningsDiv = document.getElementById('qrWarnings');

      if (!rawCard || !qrContainer) return;

      // Build share object (exclude large data)
      const shareObj = buildShareObj(rawCard);
      const encodedCard = encodeObj(shareObj);

      // Build share URL
      let baseUrl = `${location.origin}${location.pathname}`;
      
      // Normalize URL (remove existing query params)
      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // If URL parsing fails, use as-is
      }

      const shareUrl = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;

      // Clear previous content
      qrContainer.innerHTML = '';
      if (warningsDiv) warningsDiv.innerHTML = '';

      // Check for network accessibility issues
      try {
        const urlTest = new URL(baseUrl, window.location.href);
        const protocol = (urlTest.protocol || '').replace(':', '');
        const hostname = (urlTest.hostname || '').toLowerCase();

        if (protocol === 'file') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'This is a local file (<code>file://</code>). Phones cannot open that. ' +
              'Run a web server and use your network URL instead.';
          }
        } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'The QR points to <code>localhost</code>. Other devices cannot reach it. ' +
              'Use your network IP (e.g., <code>http://192.168.1.23:5500/yourfile.html</code>).';
          }
        }
      } catch (error) {
        // Ignore URL parsing errors
      }

      // Check if payload is too large for QR code
      if (encodedCard.length > 2000) {
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">
              Link is too long for QR code. Use copy/open instead:
            </p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;margin-bottom:12px;">
              ${shareUrl}
            </div>
          </div>`;
        return;
      }

      // Generate QR code using quickchart.io
      const qrImage = document.createElement('img');
      qrImage.style.maxWidth = '100%';
      qrImage.style.height = 'auto';
      qrImage.crossOrigin = 'anonymous';

      let imageLoaded = false;
      
      // Timeout fallback (5 seconds)
      const timeout = setTimeout(() => {
        if (!imageLoaded) {
          qrContainer.innerHTML = `
            <div style="padding:20px;text-align:center;">
              <p style="color:#6b7280;margin-bottom:12px;">QR generation timed out.</p>
              <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                          font-size:11px;font-family:monospace;">
                ${shareUrl}
              </div>
            </div>`;
        }
      }, 5000);

      qrImage.onload = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
      };

      qrImage.onerror = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">QR image failed to load.</p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;">
              ${shareUrl}
            </div>
          </div>`;
      };

      // Set QR code source
      qrImage.src = `https://quickchart.io/qr?text=${encodeURIComponent(shareUrl)}&size=256&dark=000000&light=ffffff`;
    }

    /**
     * Build shareable URL from current card data
     * @returns {string} Complete shareable URL
     */
    function buildShareUrlFromUI() {
      const rawCard = getMyCard();
      if (!rawCard) return `${location.origin}${location.pathname}`;

      const shareObj = buildShareObj(rawCard);
      const encodedCard = encodeObj(shareObj);

      let baseUrl = `${location.origin}${location.pathname}`;

      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // Use baseUrl as-is
      }

      return `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;
    }

    /**
     * Copy share link to clipboard
     */
    function copyShareLink() {
      const url = buildShareUrlFromUI();
      navigator.clipboard.writeText(url)
        .then(() => alert('Link copied to clipboard!'))
        .catch(() => alert('Copy failed. Please select and copy manually.'));
    }

    /**
     * Open share link in new tab (for testing)
     */
    function openShareLink() {
      const url = buildShareUrlFromUI();
      window.open(url, '_blank');
    }

    /* ==========================================================
       IMAGE CROP FUNCTIONALITY
       Allow users to position and zoom their profile picture
       ========================================================== */

    let cropState = {
      originalImage: null,
      scale: 1,
      position: { x: 0, y: 0 },
      isDragging: false,
      dragStart: { x: 0, y: 0 }
    };

    /**
     * Initialize profile picture upload handler with crop tool
     */
    document.getElementById('profilePicInput').addEventListener('change', function(event) {
      if (event.target.files && event.target.files[0]) {
        const file = event.target.files[0];

        const fileReader = new FileReader();

        fileReader.onload = function(loadEvent) {
          // Store original image
          cropState.originalImage = loadEvent.target.result;
          
          // Open crop modal
          openCropModal(cropState.originalImage);
        };

        fileReader.readAsDataURL(file);
      }
    });

    /**
     * Open the crop modal with the uploaded image
     */
    function openCropModal(imageDataUrl) {
      const modal = document.getElementById('cropModal');
      const cropImage = document.getElementById('cropImage');
      const zoomSlider = document.getElementById('zoomSlider');
      
      // Reset crop state
      cropState.scale = 1;
      cropState.position = { x: 0, y: 0 };
      cropState.isDragging = false;
      
      // Load image
      cropImage.src = imageDataUrl;
      
      // Wait for image to load to get dimensions
      cropImage.onload = function() {
        const container = document.getElementById('cropContainer');
        const containerSize = Math.min(container.clientWidth, container.clientHeight);
        
        // Calculate initial scale to fit image in container
        const imageAspect = cropImage.naturalWidth / cropImage.naturalHeight;
        
        if (imageAspect > 1) {
          // Landscape
          cropImage.style.height = containerSize + 'px';
          cropImage.style.width = (containerSize * imageAspect) + 'px';
        } else {
          // Portrait or square
          cropImage.style.width = containerSize + 'px';
          cropImage.style.height = (containerSize / imageAspect) + 'px';
        }
        
        // Center image
        centerCropImage();
      };
      
      // Reset zoom slider
      zoomSlider.value = 100;
      
      // Show modal
      modal.classList.add('active');
      document.body.classList.add('cropping');
      
      // Setup event listeners
      setupCropListeners();
    }

    /**
     * Center the crop image in the container
     */
    function centerCropImage() {
      const container = document.getElementById('cropContainer');
      const image = document.getElementById('cropImage');
      
      const containerRect = container.getBoundingClientRect();
      const imageRect = image.getBoundingClientRect();
      
      cropState.position.x = (containerRect.width - imageRect.width) / 2;
      cropState.position.y = (containerRect.height - imageRect.height) / 2;
      
      updateCropImagePosition();
    }

    /**
     * Setup drag and zoom event listeners
     */
    function setupCropListeners() {
      const container = document.getElementById('cropContainer');
      const image = document.getElementById('cropImage');
      const zoomSlider = document.getElementById('zoomSlider');
      
      // Mouse drag
      container.onmousedown = function(e) {
        e.preventDefault();
        cropState.isDragging = true;
        cropState.dragStart = {
          x: e.clientX - cropState.position.x,
          y: e.clientY - cropState.position.y
        };
      };
      
      document.onmousemove = function(e) {
        if (cropState.isDragging) {
          cropState.position.x = e.clientX - cropState.dragStart.x;
          cropState.position.y = e.clientY - cropState.dragStart.y;
          updateCropImagePosition();
        }
      };
      
      document.onmouseup = function() {
        cropState.isDragging = false;
      };
      
      // Touch drag (improved for mobile)
      container.addEventListener('touchstart', function(e) {
        const touch = e.touches[0];
        cropState.isDragging = true;
        cropState.dragStart = {
          x: touch.clientX - cropState.position.x,
          y: touch.clientY - cropState.position.y
        };
        e.preventDefault(); // Prevent scrolling while dragging
      }, { passive: false });
      
      document.addEventListener('touchmove', function(e) {
        if (cropState.isDragging) {
          e.preventDefault(); // Prevent scrolling while dragging
          const touch = e.touches[0];
          cropState.position.x = touch.clientX - cropState.dragStart.x;
          cropState.position.y = touch.clientY - cropState.dragStart.y;
          updateCropImagePosition();
        }
      }, { passive: false });
      
      document.addEventListener('touchend', function(e) {
        if (cropState.isDragging) {
          e.preventDefault();
          cropState.isDragging = false;
        }
      }, { passive: false });
      
      // Zoom slider
      zoomSlider.oninput = function() {
        const newScale = this.value / 100;
        const scaleDiff = newScale / cropState.scale;
        
        // Adjust position to zoom from center
        const container = document.getElementById('cropContainer');
        const centerX = container.clientWidth / 2;
        const centerY = container.clientHeight / 2;
        
        cropState.position.x = centerX - (centerX - cropState.position.x) * scaleDiff;
        cropState.position.y = centerY - (centerY - cropState.position.y) * scaleDiff;
        
        cropState.scale = newScale;
        updateCropImagePosition();
      };
    }

    /**
     * Update crop image position and scale
     */
    function updateCropImagePosition() {
      const image = document.getElementById('cropImage');
      image.style.transform = `translate(${cropState.position.x}px, ${cropState.position.y}px) scale(${cropState.scale})`;
      image.style.transformOrigin = '0 0';
    }

    /**
     * Cancel crop and close modal
     */
    function cancelCrop() {
      const modal = document.getElementById('cropModal');
      modal.classList.remove('active');
      document.body.classList.remove('cropping');
      
      // Clear file input
      document.getElementById('profilePicInput').value = '';
      
      // Remove event listeners
      document.onmousemove = null;
      document.onmouseup = null;
      document.ontouchmove = null;
      document.ontouchend = null;
    }

    /**
     * Save the cropped image
     */
    function saveCrop() {
      const container = document.getElementById('cropContainer');
      const image = document.getElementById('cropImage');
      
      // Create canvas for final crop
      const canvas = document.createElement('canvas');
      const size = 800; // Final image size
      canvas.width = size;
      canvas.height = size;
      
      const ctx = canvas.getContext('2d');
      
      // Calculate source dimensions from crop area
      const containerSize = container.clientWidth;
      const imageRect = image.getBoundingClientRect();
      const containerRect = container.getBoundingClientRect();
      
      // Calculate which part of the image is visible
      const scaleRatio = image.naturalWidth / imageRect.width;
      
      const sourceX = (containerRect.left - imageRect.left) * scaleRatio;
      const sourceY = (containerRect.top - imageRect.top) * scaleRatio;
      const sourceSize = containerSize * scaleRatio;
      
      // Draw cropped portion to canvas
      ctx.drawImage(
        image,
        sourceX, sourceY, sourceSize, sourceSize,
        0, 0, size, size
      );
      
      // Convert to compressed JPEG
      const croppedDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      
      // Store and update previews
      uploadedImageData = croppedDataUrl;
      document.getElementById('previewPic').src = croppedDataUrl;
      document.getElementById('profilePic').src = croppedDataUrl;
      document.getElementById('profilePicSmall').src = croppedDataUrl;
      
      // Close modal
      const modal = document.getElementById('cropModal');
      modal.classList.remove('active');
      
      // Log size
      console.log(`Cropped image size: ${(croppedDataUrl.length / 1024).toFixed(0)}KB`);
      
      // Remove event listeners
      document.onmousemove = null;
      document.onmouseup = null;
      document.ontouchmove = null;
      document.ontouchend = null;
    }
    

    /* ==========================================================
       COLOR PICKER SYNC
       Keep color picker and text input synchronized
       ========================================================== */

    // Card color sync
    document.getElementById('cardColorPicker').addEventListener('input', (event) => {
      document.getElementById('cardColorInput').value = event.target.value;
    });

    document.getElementById('cardColorInput').addEventListener('input', (event) => {
      document.getElementById('cardColorPicker').value = event.target.value;
    });

    // Background color sync
    document.getElementById('bgColorPicker').addEventListener('input', (event) => {
      document.getElementById('bgColorInput').value = event.target.value;
    });

    document.getElementById('bgColorInput').addEventListener('input', (event) => {
      document.getElementById('bgColorPicker').value = event.target.value;
    });

    /* ==========================================================
       CARD PARALLAX EFFECT
       3D tilt effect on mouse movement / touch
       ========================================================== */

    const cardContainer = document.querySelector('.card-container');

    if (cardContainer) {
      // Mouse move parallax (desktop)
      cardContainer.addEventListener('mousemove', (event) => {
        if (window.innerWidth > 768) {
          const rect = cardContainer.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          // Calculate rotation based on mouse position
          const rotateX = (y - centerY) / 10;
          const rotateY = (centerX - x) / 10;

          cardContainer.style.transform = 
            `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }
      });

      // Reset on mouse leave
      cardContainer.addEventListener('mouseleave', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });

      // Touch parallax (mobile)
      cardContainer.addEventListener('touchmove', (event) => {
        const touch = event.touches[0];
        const rect = cardContainer.getBoundingClientRect();

        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        // Gentler rotation for touch
        const rotateX = (y - centerY) / 15;
        const rotateY = (centerX - x) / 15;

        cardContainer.style.transform = 
          `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });

      // Reset on touch end
      cardContainer.addEventListener('touchend', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });
    }

    /**
     * Prevent accidental card flip when clicking interactive elements
     * Stops propagation for links, buttons, inputs, etc.
     */
    (function preventAccidentalFlip() {
      const cardRoot = document.getElementById('businessCard');
      if (!cardRoot) return;

      // Elements that should not trigger card flip
      const NON_FLIP_SELECTORS = 'a, button, input, select, textarea, [data-no-flip], .portfolio-link';

      // Use capture phase to intercept before flip handler
      ['click', 'touchstart'].forEach(eventType => {
        cardRoot.addEventListener(eventType, (event) => {
          if (event.target.closest(NON_FLIP_SELECTORS)) {
            return;
          }
        }, { capture: true });
      });
    })();

    /* ==========================================================
       APPLY CARD DATA
       Update UI with card information
       ========================================================== */

    /**
     * Apply card data to all UI elements
     * Updates the business card display and settings form
     * @param {Object} cardData - Card data to apply
     */
    function applyCardData(cardData) {
      // Update name and job title
      document.getElementById('fullName').textContent = 
        `${cardData.firstName} ${cardData.lastName}`;
      document.getElementById('jobTitle').textContent = cardData.jobTitle || '';

      // Update LinkedIn
      const linkedinLink = document.getElementById('linkedinLink');
      linkedinLink.href = cardData.linkedin || '#';
      linkedinLink.textContent = (cardData.linkedin || '')
        .replace('https://', '')
        .replace('http://', '');

      // Parse and format phone number
      let prettyPhone = cardData.phone;
      let e164Phone = cardData.phoneE164;

      if (!e164Phone && cardData.phone) {
        const parsed = parsePrettyPhone10(cardData.phone);
        if (parsed) {
          const formatted = formatPhone(parsed.cc, parsed.local);
          prettyPhone = formatted.pretty;
          e164Phone = formatted.e164;
        }
      }

      // Update phone display
      document.getElementById('phoneText').textContent = prettyPhone || '';
      document.getElementById('phoneLink').href = e164Phone ? 'tel:' + e164Phone : '#';

      // Update email
      document.getElementById('emailText').textContent = cardData.email;
      document.getElementById('emailLink').href = 'mailto:' + cardData.email;

      // Update images
      document.getElementById('profilePic').src = cardData.profilePic;
      document.getElementById('profilePicSmall').src = cardData.profilePic;
      document.getElementById('previewPic').src = cardData.profilePic;

      // Update card colors
      const cardColor = cardData.cardColor;
      document.getElementById('cardFront').style.background = 
        `linear-gradient(135deg, ${cardColor} 0%, ${cardColor} 50%, ${cardColor} 100%)`;
      document.getElementById('cardBack').style.background = cardColor;
      
      // Calculate text colors for contrast
      const textColor = contrastColor(cardColor);
      const chipBg = textColor === '#ffffff' 
        ? 'rgba(255,255,255,0.2)' 
        : 'rgba(0,0,0,0.15)';
      const chipBgHover = textColor === '#ffffff' 
        ? 'rgba(255,255,255,0.3)' 
        : 'rgba(0,0,0,0.25)';

      // Apply CSS custom properties for dynamic styling
      const cardBackEl = document.getElementById('cardBack');
      cardBackEl.style.setProperty('--card-text', textColor);
      cardBackEl.style.setProperty('--card-chip-bg', chipBg);
      cardBackEl.style.setProperty('--card-chip-bg-hover', chipBgHover);

      // Update background gradient
      document.body.style.background = 
        `radial-gradient(circle at center, white 0%, ${cardData.bgColor} 100%)`;

      // Populate settings form (only for own card, not shared)
      if (!viewingSharedCard) {
        document.getElementById('firstNameInput').value = cardData.firstName;
        document.getElementById('lastNameInput').value = cardData.lastName;
        document.getElementById('jobTitleInput').value = cardData.jobTitle || '';
        document.getElementById('emailInput').value = cardData.email;
        document.getElementById('linkedinInput').value = cardData.linkedin || '';
        document.getElementById('cardColorInput').value = cardData.cardColor;
        document.getElementById('cardColorPicker').value = cardData.cardColor;
        document.getElementById('bgColorInput').value = cardData.bgColor;
        document.getElementById('bgColorPicker').value = cardData.bgColor;

        // Portfolio URLs
        const portfolioLinks = cardData.portfolioLinks || {};

        // Handle resume - support both old string format and new object format
        let resumeData = portfolioLinks.resume;
        if (typeof resumeData === 'string') {
          // Backward compatibility
          document.getElementById('resumePdfInput').value = resumeData;
          document.getElementById('resumeDocxInput').value = '';
        } else if (resumeData && typeof resumeData === 'object') {
          document.getElementById('resumePdfInput').value = resumeData.pdf || '';
          document.getElementById('resumeDocxInput').value = resumeData.docx || '';
        } else {
          document.getElementById('resumePdfInput').value = '';
          document.getElementById('resumeDocxInput').value = '';
        }

        document.getElementById('certPageInput').value = portfolioLinks.cert || '';
        document.getElementById('eduPageInput').value = portfolioLinks.edu || '';
        document.getElementById('projPageInput').value = portfolioLinks.proj || '';
        document.getElementById('refPageInput').value = portfolioLinks.ref || '';
        document.getElementById('workPageInput').value = portfolioLinks.work || '';     

        // Phone number fields
        const countryCodeSelect = document.getElementById('countryCodeSelect');
        const localNumberInput = document.getElementById('localNumberInput');

        let countryCode = cardData.countryCode;
        let localNumber = cardData.localNumber;

        // Try to parse from pretty phone if not available
        if ((!countryCode || !localNumber) && cardData.phone) {
          const parsed = parsePrettyPhone10(cardData.phone);
          if (parsed) {
            countryCode = parsed.cc;
            localNumber = parsed.local;
          }
        }

        // Set values if valid
        countryCodeSelect.value = (countryCode && ALLOWED_COUNTRY_CODES.includes(countryCode)) 
          ? countryCode 
          : '';
        localNumberInput.value = localNumber 
          ? localNumber.replace(/\D+/g, '').slice(0, 10) 
          : '';

        // Portfolio visibility checkboxes
        const visibility = cardData.portfolioVisibility || { 
          cert: true, edu: true, proj: true, ref: true, resume: true, work: true  
        };
        document.getElementById('showCertifications').checked = visibility.cert !== false;
        document.getElementById('showEducation').checked = visibility.edu !== false;
        document.getElementById('showProjects').checked = visibility.proj !== false;
        document.getElementById('showReferences').checked = visibility.ref !== false;
        document.getElementById('showResume').checked = visibility.resume !== false;     
        document.getElementById('showWork').checked = visibility.work !== false;         
      }

      // Store portfolio links globally for button handlers
      const portfolioLinks = cardData.portfolioLinks || {};
      if (portfolioLinks.resume && typeof portfolioLinks.resume === 'string') {
        // Convert old string format to new object format
        portfolioLinks.resume = { pdf: portfolioLinks.resume, docx: '' };
      } else if (!portfolioLinks.resume) {
        // Ensure resume exists as an object
        portfolioLinks.resume = { pdf: '', docx: '' };
      }
      window.portfolioLinks = portfolioLinks;

      console.log('✅ Set window.portfolioLinks:', window.portfolioLinks); // Debug line

      // Render portfolio section with visibility settings
      renderPortfolioSection(cardData);
    }

    /* ==========================================================
       RESET TO DEFAULT
       Clear saved data and reset to John Doe template
       ========================================================== */

    /**
     * Reset card to default John Doe template
     * Clears all saved data from localStorage
     */
    function resetToJohnDoe() {
      if (!confirm('Are you sure you want to reset to default? This will delete your current card.')) {
        return;
      }

      removeMyCard();

      // Remove ?card= parameter from URL
      if (location.search.includes('card=')) {
        const cleanUrl = `${location.origin}${location.pathname}`;
        history.replaceState({}, '', cleanUrl);
      }

      // Reset viewing state
      viewingSharedCard = false;
      sharedCardData = null;

      // Apply default card
      applyCardData(DEFAULT_CARD);
      loadMyCardSection();

      alert('Card has been reset to default (John Doe).');
    }
  </script>

  <!-- =================================
       IMAGE CROP MODAL
       Allows users to position and zoom their profile picture
       ================================= -->
  <div class="crop-modal" id="cropModal">
    <div class="crop-instructions">
      Drag to reposition • Use slider to zoom
    </div>
    
    <div class="crop-container" id="cropContainer">
      <img id="cropImage" class="crop-image" src="" alt="Crop preview">
    </div>
    
    <div class="crop-controls">
      <div class="zoom-control">
        <label>Zoom:</label>
        <input 
          type="range" 
          id="zoomSlider" 
          class="zoom-slider" 
          min="100" 
          max="300" 
          value="100" 
          step="1"
        >
      </div>
      
      <div class="crop-buttons">
        <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Cancel</button>
        <button class="crop-btn crop-btn-save" onclick="saveCrop()">Save & Apply</button>
      </div>
    </div>
  </div>

</body>
</html>