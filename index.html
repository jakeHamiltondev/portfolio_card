<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Portfolio Card</title>

  <link rel="stylesheet" href="css/styles.css" />

  <script src="js/config.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/portfolio.js"></script>
  <script src="js/card.js"></script>
  <script src="js/settings.js"></script>
</head>

<body>
  <!-- =================================
       FLOATING NAVIGATION BUTTONS
       Always visible fixed buttons for navigation
       ================================= -->
  <button class="home-btn" onclick="openHome()" aria-label="Open home panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </button>

  <button class="share-btn" onclick="openShare()" id="shareButton" aria-label="Open share panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
      <polyline points="16 6 12 2 8 6"></polyline>
      <line x1="12" y1="2" x2="12" y2="15"></line>
    </svg>
  </button>

  <button class="settings-btn" onclick="openSettings()" aria-label="Open settings">
    <span class="settings-btn-inner">
      <svg class="gear" width="24" height="24" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </span>
  </button>

  <!-- =================================
       SAVE CONTACT BUTTON
       Only visible when viewing someone else's shared card
       ================================= -->
  <button class="save-contact-btn" id="saveContactBtn" onclick="saveContact()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
    </svg>
    Save to My Contacts
  </button>

  <!-- =================================
       BUSINESS CARD
       3D flip card with front and back faces
       ================================= -->
  <div class="card-container" onclick="flipCard()">
    <div class="card" id="businessCard">

      <!-- FRONT FACE: Large profile picture -->
      <div class="card-face card-front" id="cardFront">
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic"
          id="profilePic"
        />
      </div>

      <!-- BACK FACE: Contact information and portfolio links -->
      <div class="card-face card-back" id="cardBack">
        <!-- Small profile picture in corner -->
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic-small"
          id="profilePicSmall"
        />

        <div class="left-content">
          <!-- Contact information section -->
          <div>
            <div class="contact-info">
              <!-- Name links to LinkedIn profile -->
              <a id="nameLink" target="_blank" style="color: white; text-decoration: none;">
                <h2 id="fullName">John Doe</h2>
                <div id="jobTitle" style="font-size:14px;opacity:.9;margin:4px 0 10px;"></div>
              </a>
            </div>

            <!-- Email -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <a href="mailto:john.doe@email.com" id="emailLink" style="color: white; text-decoration: none;">
                <span id="emailText">john.doe@email.com</span>
              </a>
            </div>

            <!-- Phone -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <a href="tel:+15551234567" id="phoneLink" style="color: white; text-decoration: none;">
                <span id="phoneText">+1 (555) 123-4567</span>
              </a>
            </div>

            <!-- LinkedIn -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect x="2" y="9" width="4" height="12"></rect>
                <circle cx="4" cy="4" r="2"></circle>
              </svg>
              <a href="https://linkedin.com/in/johndoe" id="linkedinLink" target="_blank" style="color: white; text-decoration: none;">linkedin.com/in/johndoe</a>
            </div>
          </div>

          <!-- Portfolio links section -->
          <div>
            <div class="portfolio-links" id="portfolioSection">
              <h3>PORTFOLIO</h3>
              <div class="portfolio-links-grid">
                <button class="portfolio-link" data-link-type="cert">Certifications</button>
                <button class="portfolio-link" data-link-type="edu">Education</button>
                <button class="portfolio-link" data-link-type="proj">Projects</button>
                <button class="portfolio-link" data-link-type="ref">References</button>
                <button class="portfolio-link" data-link-type="resume">Resume</button>
                <button class="portfolio-link" data-link-type="work">Work</button>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /card-back -->

    </div>
  </div>

  <!-- Hint text for first-time users -->
  <div class="hint-text" id="hintText">Click card to see contact info</div>

  <!-- =================================
       HOME PANEL
       Shows user's own card and saved contacts
       ================================= -->
  <div class="home-panel" id="homePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeHome()">←</button>
        <h2>My Collection</h2>
      </div>
    </div>

    <!-- Tab navigation -->
    <div class="tab-container">
      <div class="tab-ribbon" id="tabRibbon">
        <button class="tab active" onclick="switchTab('myCard')">My Card</button>
        <button class="tab" onclick="switchTab('contacts')">Saved Contacts</button>
      </div>
    </div>

    <div class="home-content">
      <!-- My Card tab content -->
      <div class="tab-content active" id="myCardTab">
        <div id="myCardSection"></div>
      </div>

      <!-- Saved Contacts tab content -->
      <div class="tab-content" id="contactsTab">
        <div class="cards-grid" id="contactsGrid"></div>
      </div>
    </div>
  </div>

  <!-- =================================
       SHARE PANEL
       QR code generation and link sharing
       ================================= -->
  <div class="share-panel" id="sharePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeShare()">←</button>
        <h2>Share My Card</h2>
      </div>
    </div>

    <div class="share-content">
      <h3 style="margin-bottom: 10px;">Share via QR Code</h3>

      <p class="share-instructions">
        Others can scan this QR code to view and save your business card.
      </p>

      <div class="qr-code-container">
        <div id="qrcode"></div>

        <!-- Action buttons for QR code -->
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
          <button class="action-btn" onclick="generateQRCode()">Regenerate</button>
          <button class="action-btn" onclick="copyShareLink()">Copy Link</button>
          <button class="action-btn" onclick="openShareLink()">Open Link</button>
        </div>
      </div>

      <!-- Warning messages for network issues -->
      <div id="qrWarnings" style="max-width:500px;margin:0 auto;text-align:center;color:#b91c1c;"></div>
    </div>
  </div>

  <!-- =================================
       SETTINGS PANEL
       Edit card information and preferences
       ================================= -->
  <div class="settings-panel" id="settingsPanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeSettings()">←</button>
        <h2>My Card Settings</h2>
      </div>
    </div>

    <div class="settings-content">
      <div class="section-title">PROFILE INFORMATION</div>

      <!-- Profile picture upload -->
      <div class="form-group">
        <label>Profile Picture</label>
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px; max-width: 100%">
          <!-- Preview of current/selected image -->
          <img
            id="previewPic"
            src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
            alt="Preview"
            style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #d1d5db; flex-shrink: 0"
          />
          <div style="flex: 1; min-width: 0; max-width: 100%;">
            <input
              type="file"
              id="profilePicInput"
              accept="image/*"
              style="padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; font-size: 14px; max-width: 100%; box-sizing: border-box;"
            />
            <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Upload a photo from your device</p>
          </div>
        </div>
      </div>

      <!-- Basic information fields -->
      <div class="form-group">
        <label>First Name (Required)</label>
        <input type="text" id="firstNameInput" value="John" placeholder="ex: John" />
      </div>

      <div class="form-group">
        <label>Last Name (Required)</label>
        <input type="text" id="lastNameInput" value="Doe" placeholder="ex: Doe" />
      </div>

      <div class="form-group">
        <label>Job Title</label>
        <input type="text" id="jobTitleInput" value="Student" placeholder="Student"/>
      </div>

      <div class="form-group">
        <label>Email (Required)</label>
        <input type="email" id="emailInput" value="john.doe@email.com" placeholder="ex: john.doe@email.com"/>
        <div class="email-error-box" id="emailErrorBox"></div>
      </div>

      <!-- Phone number with country code -->
      <div class="form-group">
        <label>Phone (Required)</label>
        <div class="phone-inputs">
          <select id="countryCodeSelect" aria-label="Country code">
            <option value="">Country code…</option>
            <option value="1">+1</option>
            <option value="44">+44</option>
            <option value="61">+61</option>
            <option value="81">+81</option>
            <option value="91">+91</option>
            <option value="353">+353</option>
          </select>
          <input
            id="localNumberInput"
            type="text"
            inputmode="numeric"
            pattern="\d*"
            maxlength="10"
            placeholder="10 digits"
          />
        </div>
        <div id="phoneError" class="email-error-box" style="display: none;"></div>
      </div>

      <div class="form-group">
        <label>LinkedIn URL</label>
        <input type="text" id="linkedinInput" value="https://linkedin.com/in/johndoe" placeholder="https://linkedin.com/in/yourname" />
      </div>

      <!-- Portfolio links section -->
      <div class="section-title">PORTFOLIO LINKS</div>

      <!-- Visibility toggles for portfolio items -->
      <div class="form-group">
        <label>Portfolio Items to Display</label>
        <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
          Select which portfolio items you want to show on your card
        </p>
        <div id="portfolioVisibilityOptions" style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showCertifications" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Certifications</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showEducation" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Education</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showProjects" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Projects</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showReferences" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>References</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showResume" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Resume</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showWork" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Work</span>
          </label>
        </div>
      </div>

      <!-- URL inputs for each portfolio item -->
      <div class="form-group">
        <label>Certifications Page URL</label>
        <input type="text" id="certPageInput" value="" placeholder="https://example.com/certifications" />
      </div>

      <div class="form-group">
        <label>Education Page URL</label>
        <input type="text" id="eduPageInput" value="" placeholder="https://example.com/education" />
      </div>

      <div class="form-group">
        <label>Projects Page URL</label>
        <input type="text" id="projPageInput" value="" placeholder="https://example.com/projects" />
      </div>

      <div class="form-group">
        <label>References Page URL</label>
        <input type="text" id="refPageInput" value="" placeholder="https://example.com/references" />
      </div>

      <div class="form-group">
        <label>Resume URL - PDF Format</label>
        <input type="text" id="resumePdfInput" value="" placeholder="https://example.com/resume.pdf" />
        <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Link to your resume in PDF format</p>
      </div>

      <div class="form-group">
        <label>Resume URL - DOCX Format</label>
        <input type="text" id="resumeDocxInput" value="" placeholder="https://example.com/resume.docx" />
        <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Link to your resume in Word format (optional)</p>
      </div>

      <div class="form-group">
        <label>Work Experience URL</label>
        <input type="text" id="workPageInput" value="" placeholder="https://example.com/work" />
      </div>

      <!-- Customization section -->
      <div class="section-title">CUSTOMIZATION</div>

      <div class="form-group">
        <label>Card Color</label>
        <div class="color-input-group">
          <input type="color" id="cardColorPicker" value="#6366f1" />
          <input type="text" id="cardColorInput" value="#6366f1" />
        </div>
      </div>

      <div class="form-group">
        <label>Background Color</label>
        <div class="color-input-group">
          <input type="color" id="bgColorPicker" value="#6B46C1" />
          <input type="text" id="bgColorInput" value="#6B46C1" />
        </div>
      </div>

      <!-- Action buttons -->
      <button class="save-btn" onclick="saveSettings()">Save My Card</button>
      <button class="save-btn" onclick="resetToJohnDoe()" style="margin-top:12px;background:#ef4444">
        Reset Card to Default (John Doe)
      </button>
    </div>
  </div>

  <script>
    /* ==========================================================
       GLOBAL STATE VARIABLES
       Core application state management
       ========================================================== */

    // Card flip state
    let isFlipped = false;

    // Shared card viewing state
    let viewingSharedCard = false;  // true when viewing someone else's card via URL
    let sharedCardData = null;      // decoded data from ?card= URL parameter

    // Temporary storage for image uploads before saving
    let uploadedImageData = null;

    /* ==========================================================
       INITIALIZATION
       Check URL for shared card on page load
       ========================================================== */

    window.addEventListener('DOMContentLoaded', () => {
      checkForSharedCard();
    });

    /* ==========================================================
       SHARED CARD DETECTION
       Check URL parameters for shared card data
       ========================================================== */

    /**
     * Check if URL contains ?card= parameter and load shared card
     * Called on page load to determine viewing mode
     */
    function checkForSharedCard() {
      const urlParams = new URLSearchParams(window.location.search);
      const cardData = urlParams.get('card');

      if (cardData) {
        // We're viewing a shared card
        viewingSharedCard = true;

        try {
          // Decode the card data from URL
          sharedCardData = decodeObj(cardData);
          applyCardData(sharedCardData);

          // Show save button for visitors
          const saveBtn = document.getElementById('saveContactBtn');
          if (saveBtn) saveBtn.classList.add('show');

          // Hide share button (doesn't make sense for visitors)
          const shareBtn = document.getElementById('shareButton');
          if (shareBtn) shareBtn.style.display = 'none';

          // Update hint text
          const hint = document.getElementById('hintText');
          if (hint) hint.textContent = 'Click card to see full details';
        } catch (error) {
          console.error('Invalid card data:', error);
          loadMyCard(); // Fall back to user's own card
        }
      } else {
        // No shared card, load user's own card
        loadMyCard();
      }
    }

    /* ==========================================================
       PERSONAL CARD LOADING
       Load user's saved card from localStorage
       ========================================================== */

    /**
     * Load the user's own business card from localStorage
     * Falls back to default card if none exists
     */
    function loadMyCard() {
      viewingSharedCard = false;

      const cardData = getMyCard();

      if (cardData) {
        applyCardData(cardData);
      } else {
        // No saved card, use default template
        applyCardData(DEFAULT_CARD);
      }
    }

    /* ==========================================================
       PANEL NAVIGATION
       Open/close full-screen panels
       ========================================================== */

    /**
     * Open the home panel (My Card & Saved Contacts)
     */
    function openHome() {
      document.getElementById('homePanel').classList.add('active');
      loadMyCardSection();
      loadContacts();
    }

    /**
     * Close the home panel
     */
    function closeHome() {
      document.getElementById('homePanel').classList.remove('active');
    }

    /**
     * Open the share panel (QR code generation)
     */
    function openShare() {
      const myCard = getMyCard();
      if (!myCard) {
        alert('Please create your card in Settings first!');
        return;
      }

      document.getElementById('sharePanel').classList.add('active');
      generateQRCode();
    }

    /**
     * Close the share panel
     */
    function closeShare() {
      document.getElementById('sharePanel').classList.remove('active');
    }

    /**
     * Open the settings panel
     */
    function openSettings() {
      document.getElementById('settingsPanel').classList.add('active');
    }

    /**
     * Close the settings panel
     */
    function closeSettings() {
      document.getElementById('settingsPanel').classList.remove('active');
    }

    /* ==========================================================
       HOME PANEL TAB SWITCHING
       Toggle between My Card and Saved Contacts tabs
       ========================================================== */

    /**
     * Switch active tab in home panel
     * @param {string} tabName - Name of tab to activate ('myCard' or 'contacts')
     */
    function switchTab(tabName) {
      // Update tab button states
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content visibility
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Load appropriate content
      if (tabName === 'myCard') {
        loadMyCardSection();
      } else if (tabName === 'contacts') {
        loadContacts();
      }
    }

    /* ==========================================================
       MY CARD SECTION
       Display user's own card in home panel
       ========================================================== */

    /**
     * Load and display user's card in home panel
     * Shows empty state if no card exists
     */
    function loadMyCardSection() {
      const myCard = getMyCard();
      const section = document.getElementById('myCardSection');

      if (!myCard) {
        // Show empty state with create button
        section.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <h3>Create Your Business Card</h3>
            <p>Set up your digital business card to share with others</p>
            <button class="save-btn" onclick="openSettings()" style="max-width:200px;margin:20px auto 0;">Create My Card</button>
          </div>`;
        return;
      }

      // Calculate colors for styling
      const accent = myCard.cardColor || '#6366f1';
      const text = textOn(accent);
      const chipBg = text === '#ffffff' 
        ? 'rgba(255,255,255,0.2)' 
        : 'rgba(0,0,0,0.08)';
      const chipBorder = text === '#ffffff' ? '#ffffff' : 'rgba(0,0,0,0.2)';
      const editText = _lum(accent) > 0.85 ? '#111827' : accent;
      const borderColor = _lum(accent) < 0.45 ? '#ffffff' : '#111827';

      // Build name line with optional job title
      const nameLine = (myCard.jobTitle && myCard.jobTitle.trim())
        ? `${myCard.firstName} ${myCard.lastName} - ${myCard.jobTitle}`
        : `${myCard.firstName} ${myCard.lastName}`;

      // Render card preview
      section.innerHTML = `
        <div class="my-card-section" style="background:${accent};color:${text};border:2px solid ${borderColor}">
          <h3 style="color:${text}">My Business Card</h3>

          <div class="my-card-preview">
            <img src="${myCard.profilePic}" alt="${myCard.firstName}" class="my-card-pic">

            <div class="my-card-details">
              <h4 style="color:${text}">${nameLine}</h4>
              <p style="color:${text}">${myCard.email}</p>
              <p style="color:${text}">${myCard.phone || ''}</p>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="action-btn" onclick="closeHome(); openSettings();" 
              style="background:#fff;color:${editText};font-weight:600;border:1px solid ${chipBorder}">
              Edit Card
            </button>

            <button class="action-btn" onclick="closeHome(); openShare();" 
              style="background:${chipBg};color:${text};border:1px solid ${chipBorder};font-weight:600">
              Share Card
            </button>
          </div>
        </div>`;
    }

    /* ==========================================================
       SAVED CONTACTS MANAGEMENT
       Display, save, view, and delete saved contacts
       ========================================================== */

    /**
     * Load and display all saved contacts
     * Shows empty state if no contacts saved
     */
    function loadContacts() {
      const contacts = getSavedContacts();
      const grid = document.getElementById('contactsGrid');

      if (contacts.length === 0) {
        // Show empty state
        grid.classList.add('is-empty');
        grid.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h3>No contacts yet</h3>
            <p>When someone shares their card with you, save it here</p>
          </div>`;
        return;
      }

      grid.classList.remove('is-empty');

      // Render contact cards
      grid.innerHTML = contacts.map((contact, index) => `
        <div class="saved-card">
          <div class="saved-card-header">
            <img src="${contact.profilePic}" alt="${contact.firstName}" class="saved-card-pic">
            <div class="saved-card-info">
              <h3>${contact.firstName} ${contact.lastName}</h3>
              <p>${contact.email}</p>
            </div>
          </div>

          <div class="saved-card-actions">
            <button class="action-btn" onclick="viewContact(${index})">View</button>
            <button class="action-btn delete-btn" onclick="deleteContact(${index})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    /**
     * Save currently viewed shared card to contacts
     * Prevents duplicate saves
     */
    function saveContact() {
      if (!sharedCardData) return;

      const success = addContact(sharedCardData);

      if (!success) {
        alert('This contact is already in your collection!');
        return;
      }

      alert(`${sharedCardData.firstName} ${sharedCardData.lastName}'s card saved to your contacts!`);
      document.getElementById('saveContactBtn').classList.remove('show');
    }

    /**
     * View a saved contact's card
     * @param {number} index - Index of contact in saved contacts array
     */
    function viewContact(index) {
      const contacts = getSavedContacts();
      const contact = contacts[index];

      if (contact) {
        applyCardData(contact);
        closeHome();
      }
    }

    /**
     * Delete a saved contact
     * @param {number} index - Index of contact to delete
     */
    function deleteContact(index) {
      if (!confirm('Remove this contact?')) return;

      removeContact(index);
      loadContacts();
    }

    /**
     * Email input filter - allows only valid email characters
     */
    document.getElementById("emailInput").addEventListener("input", function(event) {
      let value = event.target.value.toLowerCase();

      // Remove invalid characters
      value = value.replace(/[^a-z0-9@._-]/g, "");
      value = value.replace(/\s+/g, "");

      // Clean up domain part (no numbers in domain)
      if (value.includes("@")) {
        const atIndex = value.indexOf("@");
        let localPart = value.slice(0, atIndex);
        let domainPart = value.slice(atIndex + 1).replace(/[0-9]/g, "");
        value = localPart + "@" + domainPart;
      }

      event.target.value = value;
    });

    /**
     * Live email validation feedback
     */
    const emailInput = document.getElementById("emailInput");
    const emailErrorBox = document.getElementById("emailErrorBox");

    emailInput.addEventListener("input", () => {
      const value = emailInput.value.trim().toLowerCase();
      const errors = getEmailErrors(value);

      if (errors.length === 0) {
        emailErrorBox.style.display = "none";
        emailErrorBox.innerHTML = "";
      } else {
        emailErrorBox.style.display = "block";
        emailErrorBox.innerHTML = "⚠ Email is invalid:<br>• " + errors.join("<br>• ");
      }
    });

    /* ==========================================================
       QR CODE GENERATION
       Generate shareable QR code using quickchart.io
       ========================================================== */

    /**
     * Generate QR code for card sharing
     * Creates shareable URL and renders QR code image
     */
    function generateQRCode() {
      const rawCard = getMyCard();
      const qrContainer = document.getElementById('qrcode');
      const warningsDiv = document.getElementById('qrWarnings');

      if (!rawCard || !qrContainer) return;

      // Build share object (exclude large data)
      const shareObj = buildShareObj(rawCard);

      const qrShareObj = { 
        ...shareObj,
      profilePic: '' };

      const encodedCard = encodeObj(qrShareObj);

      // Build share URL
      let baseUrl = `${location.origin}${location.pathname}`;
      
      // Normalize URL (remove existing query params)
      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // If URL parsing fails, use as-is
      }

      const shareUrl = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;

      // Clear previous content
      qrContainer.innerHTML = '';
      if (warningsDiv) warningsDiv.innerHTML = '';

      // Check for network accessibility issues
      try {
        const urlTest = new URL(baseUrl, window.location.href);
        const protocol = (urlTest.protocol || '').replace(':', '');
        const hostname = (urlTest.hostname || '').toLowerCase();

        if (protocol === 'file') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'This is a local file (<code>file://</code>). Phones cannot open that. ' +
              'Run a web server and use your network URL instead.';
          }
        } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'The QR points to <code>localhost</code>. Other devices cannot reach it. ' +
              'Use your network IP (e.g., <code>http://192.168.1.23:5500/yourfile.html</code>).';
          }
        }
      } catch (error) {
        // Ignore URL parsing errors
      }

      // Check if payload is too large for QR code
      if (encodedCard.length > 4000) {
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">
              QR code generation failed. Use Copy Link or Open Link buttons below:
            </p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;margin-bottom:12px;">
              ${shareUrl}
            </div>
          </div>`;
        return;
      }

      // Generate QR code using quickchart.io
      const qrImage = document.createElement('img');
      qrImage.style.maxWidth = '100%';
      qrImage.style.height = 'auto';
      qrImage.crossOrigin = 'anonymous';

      let imageLoaded = false;
      
      // Timeout fallback (5 seconds)
      const timeout = setTimeout(() => {
        if (!imageLoaded) {
          qrContainer.innerHTML = `
            <div style="padding:20px;text-align:center;">
              <p style="color:#6b7280;margin-bottom:12px;">QR generation timed out.</p>
              <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                          font-size:11px;font-family:monospace;">
                ${shareUrl}
              </div>
            </div>`;
        }
      }, 5000);

      qrImage.onload = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
      };

      qrImage.onerror = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">QR image failed to load.</p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;">
              ${shareUrl}
            </div>
          </div>`;
      };

      // Set QR code source
      qrImage.src = `https://quickchart.io/qr?text=${encodeURIComponent(shareUrl)}&size=256&dark=000000&light=ffffff`;
    }

    /**
     * Build shareable URL from current card data
     * @returns {string} Complete shareable URL
     */
    function buildShareUrlFromUI() {
      const rawCard = getMyCard();
      if (!rawCard) return `${location.origin}${location.pathname}`;

      const shareObj = buildShareObj(rawCard);
      const encodedCard = encodeObj(shareObj);

      let baseUrl = `${location.origin}${location.pathname}`;

      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // Use baseUrl as-is
      }

      return `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;
    }

    /**
     * Copy share link to clipboard
     */
    function copyShareLink() {
      const url = buildShareUrlFromUI();
      navigator.clipboard.writeText(url)
        .then(() => alert('Link copied to clipboard!'))
        .catch(() => alert('Copy failed. Please select and copy manually.'));
    }

    /**
     * Open share link in new tab (for testing)
     */
    function openShareLink() {
      const url = buildShareUrlFromUI();
      window.open(url, '_blank');
    }    

    /* ==========================================================
       CARD PARALLAX EFFECT
       3D tilt effect on mouse movement / touch
       ========================================================== */

    const cardContainer = document.querySelector('.card-container');

    if (cardContainer) {
      // Mouse move parallax (desktop)
      cardContainer.addEventListener('mousemove', (event) => {
        if (window.innerWidth > 768) {
          const rect = cardContainer.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          // Calculate rotation based on mouse position
          const rotateX = (y - centerY) / 10;
          const rotateY = (centerX - x) / 10;

          cardContainer.style.transform = 
            `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }
      });

      // Reset on mouse leave
      cardContainer.addEventListener('mouseleave', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });

      // Touch parallax (mobile)
      cardContainer.addEventListener('touchmove', (event) => {
        const touch = event.touches[0];
        const rect = cardContainer.getBoundingClientRect();

        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        // Gentler rotation for touch
        const rotateX = (y - centerY) / 15;
        const rotateY = (centerX - x) / 15;

        cardContainer.style.transform = 
          `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });

      // Reset on touch end
      cardContainer.addEventListener('touchend', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });
    }

    /**
     * Prevent accidental card flip when clicking interactive elements
     * Stops propagation for links, buttons, inputs, etc.
     */
    (function preventAccidentalFlip() {
      const cardRoot = document.getElementById('businessCard');
      if (!cardRoot) return;

      // Elements that should not trigger card flip
      const NON_FLIP_SELECTORS = 'a, button, input, select, textarea, [data-no-flip], .portfolio-link';

      // Use capture phase to intercept before flip handler
      ['click', 'touchstart'].forEach(eventType => {
        cardRoot.addEventListener(eventType, (event) => {
          if (event.target.closest(NON_FLIP_SELECTORS)) {
            return;
          }
        }, { capture: true });
      });
    })();

    // Initialize settings module
    initializeInputValidation();
    initializeColorPickers();
    initializeImageUpload
  </script>

  <!-- =================================
       IMAGE CROP MODAL
       Allows users to position and zoom their profile picture
       ================================= -->
  <div class="crop-modal" id="cropModal">
    <div class="crop-instructions">
      Drag to reposition • Use slider to zoom
    </div>
    
    <div class="crop-container" id="cropContainer">
      <img id="cropImage" class="crop-image" src="" alt="Crop preview">
    </div>
    
    <div class="crop-controls">
      <div class="zoom-control">
        <label>Zoom:</label>
        <input 
          type="range" 
          id="zoomSlider" 
          class="zoom-slider" 
          min="100" 
          max="300" 
          value="100" 
          step="1"
        >
      </div>
      
      <div class="crop-buttons">
        <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Cancel</button>
        <button class="crop-btn crop-btn-save" onclick="saveCrop()">Save & Apply</button>
      </div>
    </div>
  </div>

</body>
</html>